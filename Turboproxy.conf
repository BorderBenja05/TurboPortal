# Map for WebSockets (Shared by both sites)
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# --- SITE 1: tayamni.spa.umn.edu ---
server {
    listen 443 ssl;
    server_name tayamni.spa.umn.edu;

    ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;

    # IHW stays here as a sub-path (per your original config)
    location /ihw {
        proxy_pass http://localhost:5002/ihw;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        client_max_body_size 50M;
    }

    # Main site for tayamni
    location / {
    	proxy_pass http://localhost:5001;
    	proxy_http_version 1.1;

    	# Forward headers
    	proxy_set_header Host $host;
    	proxy_set_header X-Real-IP $remote_addr;
    	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    	proxy_set_header X-Forwarded-Proto https;

    	proxy_cookie_path / "/; secure; HttpOnly; SameSite=Lax";
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    	proxy_cache_bypass $http_upgrade;
	}
}

# --- SITE 2: skyportal.spa.umn.edu (Replace with your actual second hostname) ---
server {
    listen 443 ssl;
    server_name turboportal.spa.umn.edu; # <--- CHANGE THIS to your second DNS name

    ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;

    # SkyPortal WebSockets
    location /websocket {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # SkyPortal Main App (Now at the root of this hostname)
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Universal HTTP -> HTTPS Redirect
server {
    listen 80;
    server_name tayamni.spa.umn.edu skyportal.spa.umn.edu;
    return 301 https://$host$request_uri;
}


