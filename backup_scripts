#!/bin/bash
# backup_skyportal.sh

# Exit on error
set -e

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="skyportal_backup_$TIMESTAMP"
BACKUP_DIR="./backups/$BACKUP_NAME"
mkdir -p "$BACKUP_DIR"

echo "Starting SkyPortal backup: $BACKUP_NAME"

# 1. Backup the Database
echo "Dumping PostgreSQL database..."
docker exec postgres14.4 pg_dump -U skyportal skyportal > "$BACKUP_DIR/db_dump.sql"

# 2. Backup Named Volumes (thumbnails & persistentdata)
# We use a temporary alpine container to mount the volumes and tar them
echo "Archiving thumbnails volume..."
docker run --rm -v thumbnails:/volume -v "$(pwd)/$BACKUP_DIR":/backup alpine tar -czf /backup/thumbnails.tar.gz -C /volume .

echo "Archiving persistentdata volume..."
docker run --rm -v persistentdata:/volume -v "$(pwd)/$BACKUP_DIR":/backup alpine tar -czf /backup/persistentdata.tar.gz -C /volume .

# 3. Backup Config and DB Bind Mount
echo "Copying local configs and data..."
cp -r ./config "$BACKUP_DIR/config_backup"
# We back up the raw dbdata folder just in case, though pg_dump is our primary source
cp -r ./data/dbdata "$BACKUP_DIR/dbdata_raw"

# 4. Final compression
cd backups
tar -czf "$BACKUP_NAME.tar.gz" "$BACKUP_NAME"
rm -rf "$BACKUP_NAME"

echo "Backup complete: ./backups/$BACKUP_NAME.tar.gz"


